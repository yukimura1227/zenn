---
title: "ãˆã£ï¼ŸBrowserå†…ã§Node.jsã‚¢ãƒ—ãƒªãŒå‹•ãï¼Ÿï¼Ÿ WebContainerAPIã‚’TypeScriptã§å‹•ã‹ã—ã¦ã¿ãŸ"
emoji: "ğŸ˜"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nodejs","TypeScript","Vite","WebAssembly","WebContainers"]
published: true
---

## æ¦‚è¦

[StackBlitz](https://stackblitz.com/)ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ”¯ãˆã‚‹WebContainerã¨ã„ã†ç´ æ™´ã‚‰ã—ã„æŠ€è¡“ã®APIãŒå…¬é–‹ã•ã‚ŒãŸã®ã§ã€å®Ÿéš›ã«æ°—ã«ãªã£ã¦ã„ã‚‹æ–¹ã«å‘ã‘ã¦ã€ä½“é¨“ã—ãŸæ‰€æ„Ÿã‚’ç´¹ä»‹ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚ä¸€è¦‹ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ã®Node.jsã§ã‚„ã£ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹ã“ã¨ãŒã€å®Ÿéš›ã«ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…éƒ¨ã§å‹•ã„ã¦ã„ã‚‹ã®ã§ã€ã‚ã¡ã‚ƒãã¡ã‚ƒã™ã”ã„ã§ã™ã€‚

## å¯¾è±¡èª­è€…

- StackBlitzã«ãŠä¸–è©±ã«ãªã£ã¦ã„ã¦ã€ãã®è£å´ã®ä»•çµ„ã«èˆˆå‘³ãŒã‚ã‚‹æ–¹
- ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§ã€Node.jsã‚’å‹•ã‹ã—ãŸã„ãªãã¨æ€ã£ã¦ã„ã‚‹æ–¹
- WebContainerã«èˆˆå‘³ãŒã‚ã‚‹æ–¹

## ã¯ã˜ã‚ã«

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç•Œéšˆã§ã¯ã€æœ‰åãªplaygroundç’°å¢ƒã¨æ€ã‚ã‚Œã‚‹[StackBlitz](https://stackblitz.com/)(ã“ã®Zennã®æŒ¿å…¥ã‚‚ã§ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãªã®ã§ã€è¦‹ãŸã“ã¨ã‚ã‚‹æ–¹ã‚‚å¤šã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“)ãŒæä¾›ã—ã¦ã„ã‚‹ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ”¯ãˆã‚‹é‡è¦ãªæŠ€è¡“ã§ã‚ã‚‹ã€WebContainer(Webãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§å®Ÿç¾ã•ã‚Œã‚‹WebAssemblyãƒ™ãƒ¼ã‚¹ã®Node.jsç’°å¢ƒ)ã®APIãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸï¼ï¼

[https://blog.stackblitz.com/posts/webcontainer-api-is-here/](https://blog.stackblitz.com/posts/webcontainer-api-is-here/)
[https://www.publickey1.jp/blog/23/webwebassemblynodejswebcontainerapihttpnodejs_cli.html](https://www.publickey1.jp/blog/23/webwebassemblynodejswebcontainerapihttpnodejs_cli.html)

ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ã§ã¯ãªãã€Browserå†…ã§Node.jsãŒå‹•ãæŠ€è¡“ã§ã€npmã‚’ä½¿ã£ã¦ã€packageã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã‚Šã€ãã‚Œã‚’ä½¿ã£ã¦ã‚¢ãƒ—ãƒªã‚’å‹•ã‹ã—ãŸã‚Šã€ä»Šã¾ã§ã‚µãƒ¼ãƒã§å®Ÿç¾ã—ã¦ã„ãŸã“ã¨ãŒBrowserå†…ã§ã§ãã¦ã€ãã‚ŒãŒAPIã¨ã—ã¦å…¬é–‹ã•ã‚ŒãŸã®ã§å¤¢ãŒåºƒãŒã‚Šã¾ã™ã­ï¼ï¼
ä¾‹ãˆã°ã€ã‚¯ãƒ©ã‚¦ãƒ‰IDEã®ã‚ˆã†ã«ã€WebSocketã‚’ä½¿ã£ãŸã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªWebã‚¢ãƒ—ãƒªã‚’ä½œã‚ŠãŸã„ã€ã§ã‚‚ã€ã²ã¨ã‚Šã²ã¨ã‚Šã«å°‚æœ‰ã—ã¦ã‚‚ã‚‰ã†ãŸã‚ã®Docker Containerã‚’å‰²ã‚Šå½“ã¦ã‚‹ã®ã¯ã€ã‚³ã‚¹ãƒˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çš„ã«é›£ã—ã„ã€‚ã€‚ã€‚ã¿ãŸã„ãªã‚±ãƒ¼ã‚¹ã§ã¯ã€ç”»æœŸçš„ãªé¸æŠè‚¢ã®ä¸€ã¤ã«ãªã‚Šãˆã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

ä»Šå›ã¯ã€å…¬é–‹ã•ã‚Œã¦ã„ã‚‹[tutorial](https://webcontainers.io/guides/quickstart)ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€æœ¬å®¶ã®tutorialã§ã¯ã€VanillaJsã§Expressã‚’ä½¿ã£ãŸã‚µãƒ³ãƒ—ãƒ«ãªã®ã§ã€ã“ã“ã§ã¯ã€ãƒ¢ãƒ€ãƒ³ã«ã€TypeScriptã€fastifyã§å‹•ã‹ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

## ãã‚Œã§ã¯ã‚„ã£ã¦ã¿ã‚ˆã†

## STEP1

[å‚è€ƒï¼štutorial step1](https://webcontainers.io/tutorial/1-building-your-first-webcontainers-app)

ã¾ãšã¯ã€WebContainerã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã®é››å‹ã‚’ä½œæˆã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚
ä»Šå›ä½¿ã£ã¦ã„ã‚‹ã®Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚

```bash
node --version
# -> v19.5.0
npm --version
# -> 9.3.1

```

ã¾ãšã¯ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§é››å½¢ã‚’ä½œã‚Šã¾ã—ã‚‡ã†

```bash
# npmã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼—+ã§ã¯ã€ ' -- ' ãŒå¿…è¦ã§ã™ã€‚å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å ´åˆã¯ä¸è¦ã§ã™ã€‚
npm create vite@latest webcontainers-fastify-app -- --template vanilla-ts
```

æ¬¡ã«ã€ä½œæˆã•ã‚ŒãŸé››å½¢ã‚’å…ƒã«ã€packageã‚’installã—ã¦ã€ã¨ã‚Šã‚ãˆãšèµ·å‹•ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```bash
cd webcontainers-fastify-app/
npm install
npm run dev
```

ä»¥ä¸‹ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã‚Œã°ã€æˆåŠŸã§ã™ã®ã§ã€[](http://localhost:5173) ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```text
VITE v4.1.1  ready in 187 ms
âœ  Local:   http://localhost:5173/
âœ  Network: use --host to expose
âœ  press h to show help
```

ãƒ–ãƒ©ã‚¦ã‚¶ã«ä»¥ä¸‹ã®ã‚ˆã†ãªè¡¨ç¤ºãŒã•ã‚Œã‚Œã°æˆåŠŸã§ã™ã€‚
![Vite+TypeScript](https://storage.googleapis.com/zenn-user-upload/a3cd19dec6c7-20230216.png)

ä»Šç”»é¢ã«è¦‹ãˆã¦ã„ã‚‹ã®ãŒã€src/main.tsãªã®ã§ã€ã“ã“ã‚’æ›¸ãæ›ãˆãªãŒã‚‰WebContainerã‚’å‹•ã‹ã—ã¦ã¿ã¾ã™ã€‚
ã¾ãšã¯ã€WebContainerã‚’ä½¿ã†å‰æº–å‚™ã¨ã—ã¦ã€è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸä¸è¦ãªã‚‚ã®ã‚’å‰Šé™¤ã—ã¦ã€ãƒŸãƒ‹ãƒãƒ«ãªçŠ¶æ…‹ã«ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

```ts:src/main.ts
import './style.css';

document.querySelector('#app')!.innerHTML = ``;
```

è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã¯å‰Šé™¤ã—ã¦ã—ã¾ã„ã¾ã—ã‚‡ã†ã€‚

```bash
rm src/counter.ts
rm src/typescript.svg
```

ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®æˆæœç‰©ã¨ã—ã¦ã¯ã€å·¦å´ã«text-areaã€å³å´ã«WebContainerã‹ã‚‰ã®æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã€WebContainerãŒæº–å‚™ãŒã§ãã‚‹ã¾ã§ã®ç°¡æ˜“çš„ãªãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ã‚’ä½œã‚Šã¾ã™

```html loading.html
Installing dependencies...
```

```ts:src/main.ts
import './style.css';
document.querySelector('#app').innerHTML = `
  <!-- ã“ã“ã‚’è¿½è¨˜ã—ã¾ã—ãŸ -->
  <div class="container">
    <div class="editor">
      <textarea>I am a textarea</textarea>
    </div>
    <div class="preview">
      <iframe src="loading.html"></iframe>
    </div>
  </div>
`
```

ã¾ãŸã€æœ€ä½é™ã®è¦‹ãŸç›®ã‚’èª¿æ•´ã—ã¦ãŠããŸã‚ã€ä»¥ä¸‹ã®style.cssã‚’ä½œæˆã—ã¾ã™ã€‚

```css:src/style.css
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  height: 100vh;
}

.container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  height: 100%;
  width: 100%;
}

textarea {
  width: 100%;
  height: 100%;
  resize: none;
  border-radius: 0.5rem;
  background: black;
  color: white;
  padding: 0.5rem 1rem;
}

iframe {
  height: 100%;
  width: 100%;
  border-radius: 0.5rem;
}
```

ãƒ–ãƒ©ã‚¦ã‚¶ã®è¡¨ç¤ºãŒã“ã‚“ãªæ„Ÿã˜ã«ãªã‚Œã°OKã§ã™ã€‚

![sample](https://storage.googleapis.com/zenn-user-upload/33f50341a814-20230217.png)

## Step2

[https://webcontainers.io/tutorial/2-setting-up-webcontainers](https://webcontainers.io/tutorial/2-setting-up-webcontainers)

### Headerã®è¨­å®š

WebContainerã§ã¯ã€ç‰¹å®šã®ãƒ˜ãƒƒãƒ€ãƒ¼ãŒã¤ã„ã¦ã„ã‚‹å ´åˆã ã‘å‹•ãã‚ˆã†ãªã®ã§ã€Viteã®è¨­å®šã‚’å¤‰æ›´ã—ã¦ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ä¸ã—ã¾ã™ã€‚

```ts:vite.config.ts
import { defineConfig } from 'vite';

export default defineConfig({
  server: {
    headers: {
      'Cross-Origin-Embedder-Policy': 'require-corp',
      'Cross-Origin-Opener-Policy': 'same-origin',
    },
  },
});
```

ä¸Šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã€Viteã‚’å†èµ·å‹•ã—ã¾ã—ã‚‡ã†ã€‚
ã¾ãŸã€ç”»é¢å´ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ã»ã†ã‚‚ã€å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰(Cmd+Shift+r ã‚„  Ctrl+Shift+rã§ã™)ã™ã‚‹ã“ã¨ã§ã€ãƒ˜ãƒƒãƒ€ãƒ¼ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚

ã„ã‚ˆã„ã‚ˆã€WebContainerã®APIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã¿ã¾ã™ã€‚

### WebContainer APIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨åˆ©ç”¨

```bash
npm install @webcontainer/api
```

ä¸Šè¨˜apiã‚’åˆ©ç”¨ã™ã‚‹ã‚ˆã†ã«main.tsã‚’æ›¸ãæ›ãˆã¦ã¿ã¾ã™ã€‚

```ts:src/main.ts
import './style.css';

document.querySelector('#app')!.innerHTML = `
  <div class="container">
    <div class="editor">
      <textarea>I am a textarea</textarea>
    </div>
    <div class="preview">
      <iframe src="loading.html"></iframe>
    </div>
  </div>
`
import { WebContainer } from '@webcontainer/api';

let webcontainerInstance:WebContainer;

window.addEventListener('load', async () => {
  // Call only once
  webcontainerInstance = await WebContainer.boot();
});
```

### ã‚µãƒ¼ãƒãƒ¼å´(ä¾¿å®œä¸Šã‚µãƒ¼ãƒãƒ¼ã¨å‘¼ã³ã¾ã™)ã®å®Ÿè£…

ã•ã¦ã€ã„ã‚ˆã„ã‚ˆã€WebContainerã®é†é†å‘³ã§ã‚ã‚‹ã€ã‚µãƒ¼ãƒãƒ¼å´(â€»ã‚µãƒ¼ãƒãƒ¼å´ã¨è¨€ã£ã¦ã„ã¾ã™ãŒã€å®Ÿéš›ã«ã¯Browserå†…éƒ¨ã§ã€WebContainerãŒå‹•ä½œã—ã€ãã“ã§å‹•ãNode.jsã®ã‚¢ãƒ—ãƒªã‚’æŒ‡ã—ã¦ã„ã¾ã™)ã®å®Ÿè£…ã‚’å…¥ã‚Œã¦ã¿ã¾ã—ã‚‡ã†ã€‚
æœ¬å®¶tutorialã§ã¯ã€expressã§ã—ãŸã®ã§ã€ã“ã“ã§ã¯fastifyã‚’å‹•ã‹ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ã¾ãšã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã«èª¿æ•´ã‚’ã„ã‚Œã„ã¾ã™ã€‚WebContainerå†…ã§å‹•ãã€Node.jsã®ã‚¢ãƒ—ãƒªã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã‹ã‚‰æ›¸ãæ›ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã€WebContainerå´ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤ºã•ã›ã¦ã„ã¾ã™ã€‚

```ts:src/main.ts
import './style.css';

document.querySelector('#app')!.innerHTML = `
  <div class="container">
    <div class="editor">
      <textarea>I am a textarea</textarea>
    </div>
    <div class="preview">
      <iframe src="loading.html"></iframe>
    </div>
  </div>
`
import { WebContainer } from '@webcontainer/api';
import { files } from './webContainerSideFiles';

let webcontainerInstance:WebContainer;

window.addEventListener('load', async () => {
  // Call only once
  webcontainerInstance = await WebContainer.boot();
  await webcontainerInstance.mount(files);

  const packageJSON = await webcontainerInstance.fs.readFile('package.json', 'utf-8');
  console.log(packageJSON);

  const textareaEl = document!.querySelector('textarea');
  if( textareaEl != null) {
    textareaEl.value = files['index.js'].file.contents;
  }
});
```

æ¬¡ã«ã€WebContainerå´ã§å‹•ãNodeJsã®ã‚¢ãƒ—ãƒªã‚’å®Ÿè£…ã—ã¾ã™ã€‚
ã“ã‚ŒãŒã€ã¨ã¦ã‚‚é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚Node.jså´ã¯ã€index.jsã¨package.jsonã‹ã‚‰æ§‹æˆã•ã‚Œã‚‹ã€ã‚·ãƒ³ãƒ—ãƒ«ãªwebã‚¢ãƒ—ãƒªã§ã™ã€‚
FileSystemTreeã¨ã„ã†å‹ã«å¾“ã£ã¦ã€å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«åã¨ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã‚’å®šç¾©ã—ã¾ã™ã€‚

```ts:src/webContainerSideFiles.ts
import { FileSystemTree } from "@webcontainer/api";

export const files:FileSystemTree = {
  'index.js': {
    file: {
      contents: `
import Fastify from 'fastify';
const fastify = Fastify({
  logger: true
});

fastify.get('/', async (request, reply) => {
  return 'Welcome to a WebContainers app! ğŸ¥³';
});

const start = async () => {
  try {
    await fastify.listen({ port: 3111 });
  } catch (err) {
    fastify.log.error(err);
    process.exit(1);
  }
}
start();
`,
    },
  },
  'package.json': {
    file: {
      contents: `
{
  "name": "example-app",
  "type": "module",
  "dependencies": {
    "fastify": "latest",
    "nodemon": "latest"
  },
  "scripts": {
    "start": "nodemon index.js"
  }
}`,
    },
  },
};
```

## Step3

### WebContainerå´ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è¡Œã£ã¦ã¿ã‚‹

```js
webcontainerInstance.spawn('npm', ['install']);
```

ã“ã®ã‚ˆã†ãªå½¢ã§ã€webcontainerInstance.spawnã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€WebContainerå´ã«å‘½ä»¤ã‚’å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚

ã¨ã‚Šã‚ãˆãšã€WebContainerå´ã§npm installã—ã¦installãŒå‹•ã„ã¦ã„ãã†ãªã“ã¨ã‚’ç¢ºèªã—ã¦ã„ã¾ã—ã‚‡ã†

```ts:src/main.ts
import './style.css';

document.querySelector('#app')!.innerHTML = `
  <div class="container">
    <div class="editor">
      <textarea>I am a textarea</textarea>
    </div>
    <div class="preview">
      <iframe src="loading.html"></iframe>
    </div>
  </div>
`
import { WebContainer } from '@webcontainer/api';
import { files } from './webContainerSideFiles';

let webcontainerInstance:WebContainer;

window.addEventListener('load', async () => {
  // Call only once
  webcontainerInstance = await WebContainer.boot();
  await webcontainerInstance.mount(files);

  const packageJSON = await webcontainerInstance.fs.readFile('package.json', 'utf-8');
  console.log(packageJSON);

  const installProcess = await webcontainerInstance.spawn('npm', ['install']);

  installProcess.output.pipeTo(new WritableStream({
    write(data) {
      console.log(data);
    }
  }));

  const textareaEl = document!.querySelector('textarea');
  if( textareaEl != null) {
    textareaEl.value = files['index.js'].file.contents;
  }
});
```

ãƒ–ãƒ©ã‚¦ã‚¶ã®console.logã«ä¸‹è¨˜ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã‚Œã°OKã§ã™ã€‚
![Sample2](https://storage.googleapis.com/zenn-user-upload/044d9f789a67-20230217.png)

## Step4

WebContainerå´ã®fastifyãƒ™ãƒ¼ã‚¹ã®webã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã€€WebContainerå´ã«`npm run start`ã®å‘½ä»¤ã‚’å‡ºã›ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚(startDevServer()ã¨ãã‚Œã‚’å‘¼ã³å‡ºã™éƒ¨åˆ†ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™)

```ts:src/main.ts
import './style.css';

document.querySelector('#app')!.innerHTML = `
  <div class="container">
    <div class="editor">
      <textarea>I am a textarea</textarea>
    </div>
    <div class="preview">
      <iframe src="loading.html"></iframe>
    </div>
  </div>
`
import { WebContainer } from '@webcontainer/api';
import { files } from './webContainerSideFiles';

let webcontainerInstance:WebContainer;

window.addEventListener('load', async () => {
  // Call only once
  webcontainerInstance = await WebContainer.boot();
  await webcontainerInstance.mount(files);

  const packageJSON = await webcontainerInstance.fs.readFile('package.json', 'utf-8');
  console.log(packageJSON);

  const installProcess = await webcontainerInstance.spawn('npm', ['install']);

  if (await installProcess.exit !== 0) {
    throw new Error('Installation failed');
  };

  const textareaEl = document!.querySelector('textarea');
  if( textareaEl != null) {
    textareaEl.value = files['index.js'].file.contents;
  }

  startDevServer();
});

const startDevServer = async () => {
  console.log('npm run start!!!');
  await webcontainerInstance.spawn('npm', ['run', 'start']);

  const iframeEl = document.querySelector('iframe');
  // Wait for `server-ready` event
  webcontainerInstance.on('server-ready', (_port, url) => {
    if(iframeEl!=null) {
      iframeEl.src = url;
    }
  });
}
```

ä»¥ä¸‹ã®ã‚ˆã†ã«ã€å³å´ã®iframeã«ã€fastifyã‹ã‚‰è¿”å´ã•ã‚ŒãŸã€ã€ŒWelcome to a WebContainers app! ğŸ¥³ã€ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°OKã§ã™ã€‚

![Sample3](https://storage.googleapis.com/zenn-user-upload/abec68f1f0f4-20230217.png)

## Step5

ã“ã“ã¾ã§ã§ã€WebContainerã‹ã‚‰è¿”å´ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§å–å¾—ã—ã¦ã€è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ããŸã®ã§ã€ãã‚Œã‚’å°‘ã—ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã«ã—ã¦ã€ã¿ã¾ã—ã‚‡ã†ã€‚
å·¦å´ã®TextAreaã§WebContainerå´ã®index.jsã‚’ç·¨é›†ã—ãŸã‚‰ã€ãã‚ŒãŒWebContainerå´ã«æ›¸ãè¾¼ã¾ã‚Œã¦ã€WebContainerå´ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›¸ãæ›ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã™ã€‚

```ts:src/main.ts
import './style.css';

document.querySelector('#app')!.innerHTML = `
  <div class="container">
    <div class="editor">
      <textarea>I am a textarea</textarea>
    </div>
    <div class="preview">
      <iframe src="loading.html"></iframe>
    </div>
  </div>
`
import { WebContainer } from '@webcontainer/api';
import { files } from './webContainerSideFiles';

let webcontainerInstance:WebContainer;

window.addEventListener('load', async () => {
  // Call only once
  webcontainerInstance = await WebContainer.boot();
  await webcontainerInstance.mount(files);

  const packageJSON = await webcontainerInstance.fs.readFile('package.json', 'utf-8');
  console.log(packageJSON);

  const installProcess = await webcontainerInstance.spawn('npm', ['install']);

  if (await installProcess.exit !== 0) {
    throw new Error('Installation failed');
  };

  const textareaEl = document.querySelector('textarea') as HTMLTextAreaElement;
  if( textareaEl != null) {
    textareaEl.value = files['index.js'].file.contents;
    textareaEl.addEventListener('input', (_event) => {
      writeIndexJS(textareaEl.value);
    });
  }

  startDevServer();
});

const startDevServer = async () => {
  console.log('npm run start!!!');
  await webcontainerInstance.spawn('npm', ['run', 'start']);

  const iframeEl = document.querySelector('iframe');
  // Wait for `server-ready` event
  webcontainerInstance.on('server-ready', (_port, url) => {
    if(iframeEl!=null) {
      iframeEl.src = url;
    }
  });
}

const writeIndexJS = async (content:string) => {
  await webcontainerInstance.fs.writeFile('/index.js', content);
};
```

ç”»é¢ã‚’è¡¨ç¤ºã—ã¦ã€TextAreaå´ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”å´ã—ã¦ã„ã‚‹ã¨ã“ã‚ã‚’æ›¸ãæ›ãˆãŸã‚‰ã€WebContainerå´ã®NodeJsã®æˆ»ã‚Šã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹å³å´ã®ã‚¨ãƒªã‚¢ã«åæ˜ ã•ã‚ŒãŸã‚‰æˆåŠŸã§ã™ã€‚

![Sample4](https://storage.googleapis.com/zenn-user-upload/4d0d4d29c90d-20230217.gif)

## ãŠã‚ã‚Šã«

ã“ã“ã¾ã§ã§ã€ä¸€é€šã‚ŠWebContainerã®APIã‚’ä½“é¨“ã—ã¦ã¿ã¾ã—ãŸãŒã€ã„ã‹ãŒã§ã—ãŸã§ã—ã‚‡ã†ã‹ï¼Ÿ
ãƒ–ãƒ©ã‚¦ã‚¶ã®ä¸­ã§Node.jsã®ã‚¢ãƒ—ãƒªãŒã†ã”ã„ã¦ã€ã‚¯ãƒ©ã‚¤ãƒ³ãƒˆå´ã‹ã‚‰Node.jsã®ã‚¢ãƒ—ãƒªã‚’æ›¸ãæ›ãˆã‚‰ã‚Œã‚‹ãªã‚“ã¦ã¨ã£ã¦ã‚‚ã‚ãã‚ãã—ã¾ã›ã‚“ã‹ï¼Ÿ
ã„ã¾ã¾ã§ã ã£ãŸã‚‰ã€Docer Containerã«ã•ã›ã¦ã„ãŸã“ã¨ãŒã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§é–‰ã˜ã¦ã§ãã‚‹ã“ã¨ãŒå¢—ãˆã‚‹ã®ã§ã€ã¨ã¦ã‚‚ç”»æœŸçš„ã§ã™ã€‚ç§ã¯ã€ã“ã‚Œã‚’å…¬é–‹APIã¨ã—ã¦ãã‚Œã‚‹ã“ã¨ã«ã¨ã¦ã‚‚æ„Ÿå‹•ã—ã¾ã—ãŸã€‚
